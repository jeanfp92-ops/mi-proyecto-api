<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Sistema Epidemiológico — RIS</title>
  <link rel="stylesheet" href="/styles.css">
  <link rel="icon" href="/favicon.ico">
  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
  <style>
    .right-tabs{display:flex;gap:8px;margin-bottom:10px}
    .right-tabs .rtab{border:1px solid #cbd5e1;background:#f8fafc;padding:6px 10px;border-radius:8px;cursor:pointer;font-weight:600}
    .right-tabs .rtab.active{background:#0ea5e9;color:#fff;border-color:#0ea5e9}
    .obs-cell input.obs-input{width:100%;min-width:140px;border:1px solid #cbd5e1;padding:2px 6px;border-radius:6px;font-size:12px}
    /* Modo captura: mostrar texto y ocultar el input */
    .obs-cell .obs-display{display:none; white-space:normal; line-height:1.2}
    body.capturando .obs-input{display:none}
    body.capturando .obs-display{display:inline-block}
    .hidden{display:none !important}
    /* Refuerzo por si se sirve HTML antiguo en caché */
    #file-individual, #file-maestro { display:none !important; }
    label[for="file-individual"], label[for="file-maestro"] { display:none !important; }
  </style>
</head>
<body>
<header>Sistema Epidemiológico — RIS</header>
<div class="wrap grid">

  <!-- Panel izquierdo -->
  <section class="card">
    <h3>1) Subir archivos CSV</h3>
    <p class="note">Acepta: <b>iras.csv</b>, <b>edas.csv</b>, <b>febriles.csv</b>.</p>

    <label for="file-iras">iras.csv</label><input type="file" id="file-iras" accept=".csv"/>
    <label for="file-edas">edas.csv</label><input type="file" id="file-edas" accept=".csv"/>
    <label for="file-febriles">febriles.csv</label><input type="file" id="file-febriles" accept=".csv"/>

    <!-- Ocultos porque ya no se usan manualmente -->
    <div class="hidden">
      <label for="file-individual">individual.csv</label>
      <input type="file" id="file-individual" accept=".csv"/>
    </div>
    <div class="hidden">
      <label for="file-maestro">eess_maestro.csv</label>
      <input type="file" id="file-maestro" accept=".csv"/>
    </div>

    <div style="display:grid;grid-template-columns:repeat(2,1fr);gap:10px;margin-top:12px;">
      <div><label>Año</label><input id="ano" type="number" value="2025" min="2020" max="2030"></div>
      <div><label>Semana</label><input id="semana" type="number" value="38" min="1" max="53"></div>
    </div>

    <div style="margin-top:12px;">
      <label>RIS</label><select id="ris"><option value="">(Todas)</option></select>
    </div>

    <div style="margin-top:12px;">
      <label>Buscar establecimiento</label>
      <input id="q-est" type="text" placeholder="Escribe parte del nombre o RENAES">
    </div>

    <div style="margin-top:8px;display:flex;gap:12px;align-items:center;flex-wrap:wrap">
      <label><input type="checkbox" id="chk-compact" checked> Modo compacto</label>
      <label><input type="checkbox" id="chk-group-ris" checked> Agrupar por RIS</label>
      <label><input type="checkbox" id="chk-hide-zeros"> Ocultar filas en 0</label>
      <label><input type="checkbox" id="includeAll" checked> Mostrar todos (incl. no notificados)</label>
      <label><input type="checkbox" id="chk-excluir-mental" checked> Excluir Centros de Salud Mental (CSMC)</label>
    </div>

    <div style="margin-top:12px;display:flex;gap:8px;flex-wrap:wrap;">
      <button id="btn-subir-consolidar">Subir y consolidar</button>
      <button id="btn-capturar">Capturar JPG</button>
    </div>

    <hr>
    <div id="archivos-guardados" class="note"></div>
    <p id="msg" class="note"></p>

    <div style="margin-top:10px;"><span class="kpi ok">Est. notificados: <span id="kpi-notificados">0</span></span></div>
    <div style="margin-top:6px;"><span class="kpi bad">No notificados: <span id="kpi-nonotificados">0</span></span></div>
  </section>

  <!-- Panel derecho -->
  <section class="card">
    <div class="right-tabs">
      <button class="rtab active" data-view="consolidado">Consolidado</button>
      <button class="rtab" data-view="pivot">Series semanales</button>
    </div>

    <!-- CONSOLIDADO -->
    <div id="card-consolidado">
      <h2 id="titulo-reporte">2) Consolidado por Establecimiento — SE ?</h2>

      <div style="display:flex;gap:10px;align-items:center;margin:6px 0 10px;">
        <button id="btn-notificante">Generar Tabla Notificante</button>
        <a id="lnk-csv" href="/api/reporte/notificacion-semanal.csv" target="_blank" style="display:none">Descargar CSV</a>
        <span id="msg-notificante" class="note"></span>
      </div>

      <div id="tabla-wrap">
        <table id="tabla-resumen">
          <colgroup id="colgroup"></colgroup>
          <thead>
            <tr>
              <th class="col-ris">RIS</th>
              <th>ESTABLECIMIENTO</th>
              <th>IRA</th>
              <th>NEUMONIAS</th>
              <th>SOB.ASMA</th>
              <th>EDA ACUOSA</th>
              <th>DISENTERICA</th>
              <th>FEB</th>
              <th>OBSERVACIONES</th>
            </tr>
          </thead>
          <tbody></tbody>
          <tfoot>
            <tr>
              <td colspan="2">TOTALES</td>
              <td id="t-ira">0</td>
              <td id="t-neu">0</td>
              <td id="t-sob">0</td>
              <td id="t-daa">0</td>
              <td id="t-dis">0</td>
              <td id="t-feb">0</td>
              <td></td>
            </tr>
          </tfoot>
        </table>
      </div>
    </div>

    <!-- PIVOT -->
    <div id="card-pivot" style="display:none">
      <h3>Series semanales</h3>
      <div class="pivot-controls">
        <div class="tabs" id="tabs-vigilancia">
          <button data-ind="EDA" class="active">EDA</button>
          <button data-ind="IRA">IRA</button>
          <button data-ind="NEU">NEU</button>
          <button data-ind="SOBASMA">SOB/ASMA</button>
          <button data-ind="FEB">FEB</button>
        </div>
        <div class="pivot-filters">
          <label>Ver por</label>
          <select id="pv-group">
            <option value="estab">Establecimiento</option>
            <option value="ris">RIS</option>
          </select>
          <label>Semanas</label>
          <input id="pv-desde" type="number" min="1" max="53" value="1" style="width:68px">
          <span>—</span>
          <input id="pv-hasta" type="number" min="1" max="53" value="38" style="width:68px">
          <button id="pv-actualizar">Actualizar</button>
        </div>
      </div>
      <div id="pivot-wrap"><table id="pivot-table"></table></div>
    </div>
  </section>
</div>

<script>
/* ================== API endpoints ================== */
var api = {
  upload: '/api/upload',
  files:  '/api/files',
  risOptions: '/api/epi/ris-options',
  summary: function(a,s,ris,all) {
    var p = new URLSearchParams({ ano: a, semana: s, includeAll: String(all) });
    if (ris) p.append('ris', ris);
    return '/api/epi/summary?' + p.toString();
  }
};
var lastSummary = null;

/* ========== AUTO-CARGA eess_maestro.csv (NUEVO) ========== */
var MAESTRO_URL = '/static/data/eess_maestro.csv'; // ajusta tu ruta

async function maestroExisteEnServidor(){
  try{
    var r = await fetch(api.files);
    if(!r.ok) return false;
    var list = await r.json();
    return Array.isArray(list) && list.some(function(x){ return (x.name||'').toLowerCase() === 'eess_maestro.csv'; });
  }catch(e){ return false; }
}

async function subirMaestroDesdeURL(){
   try{
    const url = MAESTRO_URL + '?v=' + Date.now(); // evita copiar una respuesta cacheada 404
    const resp = await fetch(url, { cache: 'no-store' });
    if(!resp.ok){
      console.warn('No se halló eess_maestro.csv en', MAESTRO_URL, 'status=', resp.status);
      return false; // no rompas el flujo
    }
    const text = await resp.text();
    const blob = new Blob([text], { type: 'text/csv' });
    const fd = new FormData();
    fd.append('file', blob, 'eess_maestro.csv');
    const up = await fetch(api.upload, { method:'POST', body: fd });
    if(!up.ok){
      console.warn('No se pudo subir eess_maestro.csv:', await up.text());
      return false;
    }
    return true;
  }catch(e){
    console.warn('subirMaestroDesdeURL error:', e);
    return false;
  }
}

async function asegurarMaestro(){
  try{
    const ya = await maestroExisteEnServidor();
    if(!ya){
      const ok = await subirMaestroDesdeURL();
      if(!ok){ await refrescarArchivos(); return false; }
    }
    await refrescarArchivos();
    return true;
  }catch(e){
    console.warn('asegurarMaestro error:', e);
    return false;
  }
}
/* =================================================== */

/* ---------- utilidades ---------- */
function sumRow(f){return (f.ira|0)+(f.neumonias|0)+(f.sob_asma|0)+(f.eda_acuosa|0)+(f.disenterica|0)+(f.feb|0)}
function sumArray(arr,key){return arr.reduce(function(s,x){return s+(x[key]|0)},0)}
function groupByFn(arr, keyFn){
  var m = new Map();
  for (var i=0;i<arr.length;i++){
    var x = arr[i];
    var kVal = keyFn(x);
    var k = (kVal != null ? kVal : '');
    if(!m.has(k)) m.set(k,[]);
    m.get(k).push(x);
  }
  return m;
}
async function uploadCsv(el, forcedName){
  if(!el || !el.files || el.files.length===0) return;
  var fd=new FormData();
  fd.append('file', el.files[0], forcedName);
  var r=await fetch(api.upload,{method:'POST',body:fd});
  if(!r.ok) throw new Error(await r.text());
}

async function refrescarArchivos(){
  var r = await fetch(api.files);
  if (!r.ok) return;

  var list = await r.json();
  var ocultar = new Set(['individual.csv']);
  list = list.filter(function(x){ return !ocultar.has((x.name||'').toLowerCase()); });

  var el = document.getElementById('archivos-guardados');
  if (el) el.textContent = 'Archivos guardados: ' + list.length + ' — ' + list.map(function(x){return x.name}).join(', ');
}

async function cargarOpcionesRIS(){
  try{
    var r = await fetch(api.risOptions);
    if (!r.ok) return;

    var json = await r.json();
    var options = (json && Array.isArray(json.options)) ? json.options : [];

    var sel = document.getElementById('ris');
    if (sel) {
      sel.innerHTML = '<option value="">(Todas)</option>' + options.map(function(o){return '<option>'+o+'</option>';}).join('');
    }

    var pvSel = document.getElementById('pv-group');
    if (pvSel && options.length) {
      options.forEach(function(o){
        var opt = document.createElement('option');
        opt.value = 'ris:'+o;
        opt.textContent = o;
        pvSel.appendChild(opt);
      });
    }
  }catch(e){
    console.warn('cargarOpcionesRIS error:', e);
  }
}

/* ---------- filtro Salud Mental (CSMC) ---------- */
function esSaludMental(f){
  var raw=(f.establecimiento||'');
  var nombre=raw.normalize('NFD').replace(/[\u0300-\u036f]/g,'').toUpperCase();
  var colapsado=nombre.replace(/[^A-Z]/g,''); // C.S.M.C. -> CSMC
  if(colapsado.indexOf('CSMC')!==-1) return true;
  return /\bSALUD\s*MENTAL\b/.test(nombre)
      || /\bMENTAL\s*COMUNITARIO\b/.test(nombre)
      || /\bCOMUNITARIO\s*DE\s*SALUD\s*MENTAL\b/.test(nombre);
}
function getExclMental(){
  var v=localStorage.getItem('excluir_csmc');
  return v===null ? true : v==='1';
}
function setExclMental(on){
  localStorage.setItem('excluir_csmc',on?'1':'0');
  var el=document.getElementById('chk-excluir-mental');
  if(el) el.checked=!!on;
}

/* ---------- Observaciones (localStorage) ---------- */
function obsKey(y,w,f){
  var id=(f.renaes&&f.renaes.trim())?f.renaes.trim():(f.establecimiento||'').trim();
  return 'obs:'+y+':'+w+':'+id;
}
function getObs(y,w,f){return localStorage.getItem(obsKey(y,w,f))||''}
function setObs(y,w,f,txt){localStorage.setItem(obsKey(y,w,f),txt||'')}

/* ---------- tabla consolidado ---------- */
function buildColgroup(){
  var grouped=(document.getElementById('chk-group-ris') && document.getElementById('chk-group-ris').checked);
  var cg=document.getElementById('colgroup');
  if(!cg) return;

  if(grouped){
    cg.innerHTML = '\
      <col style="width:50%">\
      <col style="width:16%">\
      <col style="width:6.8%">\
      <col style="width:6.8%">\
      <col style="width:6.8%">\
      <col style="width:6.8%">\
      <col style="width:6.8%">\
      <col style="width:6.8%">\
      <col style="width:8%">';
  }else{
    cg.innerHTML = '\
      <col style="width:16%">\
      <col style="width:34%">\
      <col style="width:7%">\
      <col style="width:7%">\
      <col style="width:7%">\
      <col style="width:7%">\
      <col style="width:7%">\
      <col style="width:7%">\
      <col style="width:8%">';
  }
}
function fitTableToPanel(){
  var wrap=document.getElementById('tabla-wrap'), table=document.getElementById('tabla-resumen'); if(!wrap||!table) return;
  table.style.transform='scale(1)'; wrap.style.overflowX='hidden';
  requestAnimationFrame(function(){
    var available=wrap.clientWidth-6;
    var need=table.scrollWidth;
    if(need<=0)return;
    var scale=available/need;
    if(scale<0.85){table.style.transform='scale(1)';wrap.style.overflowX='auto'} else {table.style.transform='scale('+Math.min(1,scale)+')'}
  });
}
function autoSizeColumns(){
  var table=document.getElementById('tabla-resumen'), cg=document.getElementById('colgroup'); if(!table||!cg) return;
  table.style.tableLayout='auto'; table.style.width='auto';
  Array.prototype.forEach.call(table.querySelectorAll('th,td'), function(c){
    c.style.whiteSpace='nowrap';c.style.overflow='visible';c.style.textOverflow='clip';
  });
  var thead=table.tHead, tbody=table.tBodies[0]; if(!thead||!tbody) return;
  var ths=Array.from(thead.rows[0].cells); var nCols=ths.length; var rows=Array.from(tbody.rows).slice(0,60); var maxW=new Array(nCols).fill(0);
  ths.forEach(function(th,j){maxW[j]=Math.max(maxW[j],th.scrollWidth)});
  rows.forEach(function(tr){Array.from(tr.cells).forEach(function(td,j){maxW[j]=Math.max(maxW[j],td.scrollWidth)})});
  var isGrouped=(document.getElementById('chk-group-ris') && document.getElementById('chk-group-ris').checked);
  var minNumPx=48,minEstPx=280,minRisPx=140;
  var weights=maxW.map(function(w,j){
    if(!isGrouped&&j===0) return Math.max(w,minRisPx);
    if((!isGrouped&&j===1)||(isGrouped&&j===0)) return Math.max(w,minEstPx);
    return Math.max(w,minNumPx);
  });
  var total=weights.reduce(function(a,b){return a+b},0)||1;
  cg.innerHTML=weights.map(function(w){return '<col style="width:'+(w/total*100).toFixed(4)+'%">' }).join('');
  table.style.tableLayout='fixed'; table.style.width='max-content';
  fitTableToPanel();
}
function toggleGroupedClass(){
  var wrap=document.getElementById('tabla-wrap');
  var grouped=(document.getElementById('chk-group-ris') && document.getElementById('chk-group-ris').checked);
  if(wrap){ wrap.classList.toggle('grouped', !!grouped); }
}

function renderTabla(data){
  lastSummary=data;
  var wrap=document.getElementById('tabla-wrap');
  var compact=(document.getElementById('chk-compact') && document.getElementById('chk-compact').checked);
  var groupRis=(document.getElementById('chk-group-ris') && document.getElementById('chk-group-ris').checked);
  var hideZeros=(document.getElementById('chk-hide-zeros') && document.getElementById('chk-hide-zeros').checked);
  if(wrap) wrap.classList.toggle('compact',!!compact);

  var y=parseInt(document.getElementById('ano').value,10);
  var w=parseInt(document.getElementById('semana').value,10);

  var q=(document.getElementById('q-est').value||'').trim().toLowerCase();
  var filas=(data && data.filas ? data.filas.slice() : []);

  if(getExclMental()) filas=filas.filter(function(f){return !esSaludMental(f)});
  if(q){ filas=filas.filter(function(f){return (f.establecimiento||'').toLowerCase().indexOf(q)!==-1 || (f.renaes||'').toLowerCase().indexOf(q)!==-1 }) }
  if(hideZeros) filas=filas.filter(function(f){return sumRow(f)>0});

  var tb=document.querySelector('#tabla-resumen tbody');

  if(!groupRis){
    tb.innerHTML=filas.map(function(f){
      return '\
      <tr>\
        <td class="col-ris" title="'+(f.ris||'')+'">'+(f.ris||'')+'</td>\
        <td title="'+f.establecimiento+'">'+f.establecimiento+'</td>\
        <td>'+f.ira+'</td><td>'+f.neumonias+'</td><td>'+f.sob_asma+'</td><td>'+f.eda_acuosa+'</td><td>'+f.disenterica+'</td><td>'+f.feb+'</td>\
        <td class="obs-cell">\
          <input class="obs-input" type="text"\
           value="'+(getObs(y,w,f)).replace(/"/g,'&quot;')+'"\
           data-renaes="'+(f.renaes||'')+'"\
           data-est="'+(String(f.establecimiento||'').replace(/"/g,'&quot;'))+'">\
          <span class="obs-display">'+(getObs(y,w,f))+'</span>\
        </td>\
      </tr>';
    }).join('');
  }else{
    var g=groupByFn(filas,function(f){ return (f.ris||'').trim(); });
    var blocks=[];
    g.forEach(function(arr, ris){
      var gi={ira:sumArray(arr,'ira'),neu:sumArray(arr,'neumonias'),sob:sumArray(arr,'sob_asma'),daa:sumArray(arr,'eda_acuosa'),dis:sumArray(arr,'disenterica'),feb:sumArray(arr,'feb')};
      blocks.push('<tr class="group-row"><td colspan="2">'+(ris||'(Sin RIS)')+' — '+arr.length+' EESS</td><td>'+gi.ira+'</td><td>'+gi.neu+'</td><td>'+gi.sob+'</td><td>'+gi.daa+'</td><td>'+gi.dis+'</td><td>'+gi.feb+'</td><td></td></tr>');
      arr.forEach(function(f){
        blocks.push('<tr>\
          <td></td><td>'+f.establecimiento+'</td>\
          <td>'+f.ira+'</td><td>'+f.neumonias+'</td><td>'+f.sob_asma+'</td><td>'+f.eda_acuosa+'</td><td>'+f.disenterica+'</td><td>'+f.feb+'</td>\
          <td class="obs-cell"><input class="obs-input" type="text" value="'+(getObs(y,w,f)).replace(/"/g,'&quot;')+'" data-renaes="'+(f.renaes||'')+'" data-est="'+(String(f.establecimiento||'').replace(/"/g,'&quot;'))+'"></td>\
        </tr>');
      });
    });
    tb.innerHTML=blocks.join('');
  }

  var tVis={ira:sumArray(filas,'ira'),neumonias:sumArray(filas,'neumonias'),sob_asma:sumArray(filas,'sob_asma'),eda_acuosa:sumArray(filas,'eda_acuosa'),disenterica:sumArray(filas,'disenterica'),feb:sumArray(filas,'feb')};
  document.getElementById('t-ira').textContent=tVis.ira;
  document.getElementById('t-neu').textContent=tVis.neumonias;
  document.getElementById('t-sob').textContent=tVis.sob_asma;
  document.getElementById('t-daa').textContent=tVis.eda_acuosa;
  document.getElementById('t-dis').textContent=tVis.disenterica;
  document.getElementById('t-feb').textContent=tVis.feb;

  document.getElementById('kpi-notificados').textContent=(data && data.conteo_estab_notificados!=null)?data.conteo_estab_notificados:0;
  document.getElementById('kpi-nonotificados').textContent=(data && data.conteo_estab_no_notificados!=null)?data.conteo_estab_no_notificados:0;

  var msg=document.getElementById('msg'); if(msg) msg.textContent='OK';
  requestAnimationFrame(function(){buildColgroup();autoSizeColumns()});
}

/* guarda Observaciones por delegación */
var tablaWrapEl = document.getElementById('tabla-wrap');
if (tablaWrapEl) {
  tablaWrapEl.addEventListener('input', function(ev){
    var target = ev.target || ev.srcElement;
    var inp = target && target.closest ? target.closest('input.obs-input') : (target && target.classList && target.classList.contains('obs-input') ? target : null);
    if(!inp) return;
    var y = parseInt(document.getElementById('ano').value,10);
    var w = parseInt(document.getElementById('semana').value,10);
    var f = { renaes: inp.getAttribute('data-renaes'), establecimiento: inp.getAttribute('data-est') };
    setObs(y, w, f, inp.value);
    var span = inp.parentElement.querySelector('.obs-display');
    if (span) span.textContent = inp.value;
  });
}

/* ---------- Semana epidemiológica ---------- */
function startOfSE1(year){var jan4=new Date(year,0,4);var dow=jan4.getDay();var sunday=new Date(jan4);sunday.setDate(jan4.getDate()-dow);return sunday}
function rangoSE(year,se){var start=startOfSE1(year);start.setDate(start.getDate()+(se-1)*7);var end=new Date(start);end.setDate(start.getDate()+6);return {ini:start,fin:end}}
var dfmt=function(d){return d.toLocaleDateString('es-PE',{day:'2-digit',month:'short'});};
function actualizarEncabezadoSE(){
  var y=parseInt(document.getElementById('ano') && document.getElementById('ano').value,10);
  var w=parseInt(document.getElementById('semana') && document.getElementById('semana').value,10);
  var h2=document.getElementById('titulo-reporte');
  if(!y||!w||!h2) return;
  var rf=rangoSE(y,w);
  h2.textContent='2) Consolidado por Establecimiento — SEMANA EPIDEMIOLÓGICA '+w+' ('+dfmt(rf.ini)+'–'+dfmt(rf.fin)+' '+y+')';
}

/* ---------- acciones principales ---------- */
async function subirYConsolidar(){
  try{
    var ano=parseInt(document.getElementById('ano').value,10);
    var semana=parseInt(document.getElementById('semana').value,10);
    var ris=document.getElementById('ris').value.trim();
    var includeAll=document.getElementById('includeAll').checked;

    await uploadCsv(document.getElementById('file-iras'),'iras.csv');
    await uploadCsv(document.getElementById('file-edas'),'edas.csv');
    await uploadCsv(document.getElementById('file-febriles'),'febriles.csv');
    // Maestro: ahora se asegura automáticamente desde URL
    await asegurarMaestro();

    await refrescarArchivos();

    var url=api.summary(ano, semana, ris||undefined, includeAll);
    var r=await fetch(url); if(!r.ok) throw new Error(await r.text());
    var data=await r.json();
    renderTabla(data);
    actualizarEncabezadoSE();
  }catch(err){console.error(err);alert('Error: '+err.message)}
}

async function capturarJPG(){
  actualizarEncabezadoSE();

  document.body.classList.add('capturando');
  Array.prototype.forEach.call(document.querySelectorAll('input.obs-input'), function(inp){
    var span = inp.parentElement.querySelector('.obs-display');
    if (span) span.textContent = inp.value;
    inp.setAttribute('value', inp.value);
  });

  var pivot = document.getElementById('card-pivot');
  var visCard = (pivot && pivot.style.display==='block') ? pivot : document.getElementById('card-consolidado');

  var wrapTabla=document.getElementById('tabla-wrap');
  var prevCompact=wrapTabla && wrapTabla.classList.contains('compact');
  if(wrapTabla) wrapTabla.classList.add('compact');

  var ano=document.getElementById('ano').value;
  var semana=document.getElementById('semana').value;
  var ris=document.getElementById('ris').value||'todas';

  var canvas=await html2canvas(visCard,{scale:2, backgroundColor:'#ffffff'});
  var dataURL=canvas.toDataURL('image/jpeg',0.92);
  var a=document.createElement('a');
  a.href=dataURL;
  a.download='tablero_'+(visCard.id==='card-pivot'?'pivot':'consolidado')+'_SE'+semana+'_A'+ano+'_'+ris.replace(/\s+/g,'_')+'.jpg';
  a.click();

  if(wrapTabla && !prevCompact) wrapTabla.classList.remove('compact');
  document.body.classList.remove('capturando');
}

async function generarTablaNotificante(){
  try{
    if(!lastSummary || !lastSummary.filas){alert('Primero genera el consolidado.');return}
    actualizarEncabezadoSE();
    var ano=parseInt(document.getElementById('ano').value,10);
    var semana=parseInt(document.getElementById('semana').value,10);
    var ris=document.getElementById('ris').value.trim();

    var payload={
      anio:ano, semana: semana, ubigeo:"", ris: (ris||null),
      filas:lastSummary.filas.map(function(f){return {renaes:f.renaes, ira:f.ira, neumonias:f.neumonias, sob_asma:f.sob_asma, eda_acuosa:f.eda_acuosa, disenterica:f.disenterica, feb:f.feb};})
    };

    var r=await fetch('/api/reporte/notificacion-semanal',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(payload)});
    if(!r.ok) throw new Error(await r.text());
    var lnk=document.getElementById('lnk-csv'); if(lnk) lnk.style.display='inline-block';
    var msg=document.getElementById('msg-notificante'); if(msg) msg.textContent='Reporte generado.';
  }catch(e){console.error(e);var m=document.getElementById('msg-notificante'); if(m) m.textContent='Error generando reporte';alert('Error generando reporte: '+e.message)}
}

/* ---------- PIVOT ---------- */
function apiPivot(ano,ind,groupBy,s1,s2,ris){
  var p=new URLSearchParams({ano: ano, indicator: ind, groupBy: groupBy, semana_ini: s1, semana_fin: s2});
  if(ris) p.append('ris',ris);
  return '/api/epi/pivot?'+p.toString();
}
function drawSparkline(canvas,values){
  if(!canvas)return;
  var w=canvas.width=canvas.clientWidth,h=canvas.height=canvas.clientHeight;
  var ctx=canvas.getContext('2d');
  ctx.clearRect(0,0,w,h);
  if(!values||values.length===0)return;
  var max=Math.max(1,Math.max.apply(null,values));
  var step=w/Math.max(1,values.length-1);
  ctx.lineWidth=1;
  ctx.strokeStyle='#1e88e5';
  ctx.beginPath();
  values.forEach(function(v,i){
    var x=Math.round(i*step),y=Math.round(h-(v/max)*h);
    if(i===0) ctx.moveTo(x,y); else ctx.lineTo(x,y);
  });
  ctx.stroke();
  var lastVal = values[values.length-1];
  var lastX=Math.round((values.length-1)*step),lastY=Math.round(h-(lastVal/max)*h);
  ctx.fillStyle='#1e88e5';
  ctx.beginPath();ctx.arc(lastX,lastY,2,0,Math.PI*2);ctx.fill();
}
async function cargarPivot(){
  var ano=parseInt(document.getElementById('ano').value,10);
  var s1=parseInt(document.getElementById('pv-desde').value,10);
  var s2=parseInt(document.getElementById('pv-hasta').value,10);
  var groupSel=document.getElementById('pv-group').value;
  var group='estab'; var risFilter=(document.getElementById('ris') && document.getElementById('ris').value || '').trim();
  if(groupSel==='ris'){group='ris';risFilter=''} else if(groupSel.indexOf('ris:')===0){group='estab';risFilter=groupSel.substring(4)}
  var tabs = document.getElementById('tabs-vigilancia');
  var activeBtn = tabs ? tabs.querySelector('button.active') : null;
  var ind = activeBtn ? activeBtn.getAttribute('data-ind') : 'EDA';
  var url=apiPivot(ano,ind,group,s1,s2,risFilter||undefined);
  var r=await fetch(url);
  if(!r.ok){console.error(await r.text());return}
  var data=await r.json();
  renderPivot(data);
}
function renderPivot(data){
  var semanas=data.semanas;
  var rows=(data && data.rows != null ? data.rows : []);
  var total=data.totalFila;
  if(getExclMental() && data.groupBy==='estab'){
    rows=rows.filter(function(r){return !esSaludMental({establecimiento:r.label});});
    var colSums=new Array(semanas.length).fill(0);
    rows.forEach(function(r){r.values.forEach(function(v,i){colSums[i]+= (v|0);});});
    total={label:'TOTALES',values:colSums, total:colSums.reduce(function(a,b){return a+b;},0)};
  }
  var t=document.getElementById('pivot-table');
  var thead='<thead><tr><th class="pv-sticky">'+(data.groupBy==='estab'?'ESTABLECIMIENTO':'RIS')+'</th>'+semanas.map(function(s){return '<th>SE '+s+'</th>';}).join('')+'<th>TOTAL</th><th>TENDENCIA</th></tr></thead>';
  var tbody='<tbody>';
  rows.forEach(function(r){
    tbody+='<tr><td class="pv-sticky">'+r.label+'</td>'+r.values.map(function(v){return '<td style="text-align:right">'+v+'</td>';}).join('')+'<td style="text-align:right;font-weight:600">'+r.total+'</td><td><canvas class="spark" data-serie="'+r.values.join(',')+'"></canvas></td></tr>';
  });
  tbody+='</tbody>';
  var tfoot='<tfoot><tr><td class="pv-sticky">'+total.label+'</td>'+total.values.map(function(v){return '<td style="text-align:right">'+v+'</td>';}).join('')+'<td style="text-align:right">'+total.total+'</td><td></td></tr></tfoot>';
  t.innerHTML=thead+tbody+tfoot;
  Array.prototype.forEach.call(t.querySelectorAll('canvas.spark'), function(cv){
    var serie=(cv.getAttribute('data-serie')||'').split(',').map(function(x){return parseInt(x,10)||0;});
    drawSparkline(cv,serie);
  });
}

/* ---------- listeners ---------- */
var tabsVig = document.getElementById('tabs-vigilancia');
if (tabsVig){
  tabsVig.addEventListener('click', function(ev){
    var btn=(ev.target && ev.target.closest) ? ev.target.closest('button[data-ind]') : null;
    if(!btn) return;
    Array.prototype.forEach.call(document.querySelectorAll('#tabs-vigilancia button'), function(b){ b.classList.remove('active'); });
    btn.classList.add('active');
    cargarPivot();
  });
}
var pvAct = document.getElementById('pv-actualizar');
if (pvAct){ pvAct.addEventListener('click', cargarPivot); }
var risSel = document.getElementById('ris');
if (risSel){
  risSel.addEventListener('change', function(){
    var cardPivot=document.getElementById('card-pivot');
    if(cardPivot && cardPivot.style.display==='block') cargarPivot();
  });
}
window.addEventListener('resize', function(){
  Array.prototype.forEach.call(document.querySelectorAll('canvas.spark'), function(cv){
    var serie=(cv.getAttribute('data-serie')||'').split(',').map(function(x){return parseInt(x,10)||0;});
    drawSparkline(cv,serie);
  });
});

var views={consolidado:document.getElementById('card-consolidado'),pivot:document.getElementById('card-pivot')};
var rightTabs = document.querySelector('.right-tabs');
if (rightTabs){
  rightTabs.addEventListener('click', function(ev){
    var btn=(ev.target && ev.target.closest) ? ev.target.closest('.rtab') : null;
    if(!btn)return;
    Array.prototype.forEach.call(document.querySelectorAll('.right-tabs .rtab'), function(b){ b.classList.remove('active'); });
    btn.classList.add('active');
    var v=btn.getAttribute('data-view');
    Object.keys(views).forEach(function(k){
      var el=views[k];
      if(el) el.style.display=(k===v?'block':'none');
    });
    if(v==='pivot') cargarPivot();
  });
}

var btnSub = document.getElementById('btn-subir-consolidar');
if (btnSub){ btnSub.addEventListener('click', subirYConsolidar); }
var btnCap = document.getElementById('btn-capturar');
if (btnCap){ btnCap.addEventListener('click', capturarJPG); }
var btnNot = document.getElementById('btn-notificante');
if (btnNot){ btnNot.addEventListener('click', generarTablaNotificante); }

['chk-compact','chk-group-ris','chk-hide-zeros'].forEach(function(id){
  var el=document.getElementById(id);
  if(el) el.addEventListener('change', function(){
    toggleGroupedClass();
    if(lastSummary) renderTabla(lastSummary);
    requestAnimationFrame(function(){autoSizeColumns()});
  });
});
var qEst = document.getElementById('q-est');
if (qEst){
  qEst.addEventListener('input', function(){ if(lastSummary) renderTabla(lastSummary); });
}

// Switch CSMC persistente
setExclMental(getExclMental());
var chkEx = document.getElementById('chk-excluir-mental');
if (chkEx){
  chkEx.addEventListener('change', function(e){
    setExclMental(e.target.checked);
    if(lastSummary) renderTabla(lastSummary);
    var cardPivot=document.getElementById('card-pivot');
    if(cardPivot && cardPivot.style.display==='block') cargarPivot();
  });
}

/* Inicial — ahora asegurado al estar el DOM listo */
window.addEventListener('DOMContentLoaded', function () {
  buildColgroup();
  refrescarArchivos();
  cargarOpcionesRIS();
  actualizarEncabezadoSE();
  asegurarMaestro().catch(function(e){ console.warn('asegurarMaestro()', e); });
});
</script>
</body>
</html>
